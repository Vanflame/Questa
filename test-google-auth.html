<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Auth Test - Questa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }

        .test-button:hover {
            background: #3367d6;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .error {
            color: #dc3545;
        }

        .success {
            color: #28a745;
        }

        .info {
            color: #17a2b8;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>Google Authentication Test</h1>
        <p>This page helps debug Google OAuth issues. Check the console and logs below.</p>

        <div>
            <button class="test-button" onclick="testGoogleAuth()">Test Google Sign-In (Popup)</button>
            <button class="test-button" onclick="testGoogleAuthRedirect()">Test Google Sign-In (Redirect)</button>
            <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        </div>

        <div id="logs" class="log"></div>

        <div id="user-info"
            style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; display: none;">
            <h3>User Information</h3>
            <div id="user-details"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="/assets/js/firebase-config.js"></script>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function showUserInfo(user) {
            const userInfo = document.getElementById('user-info');
            const userDetails = document.getElementById('user-details');

            userDetails.innerHTML = `
                <p><strong>UID:</strong> ${user.uid}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Display Name:</strong> ${user.displayName || 'N/A'}</p>
                <p><strong>Photo URL:</strong> ${user.photoURL || 'N/A'}</p>
                <p><strong>Provider:</strong> ${user.providerData[0]?.providerId || 'N/A'}</p>
            `;

            userInfo.style.display = 'block';
        }

        async function testGoogleAuth() {
            log('Starting Google Auth test (Popup method)...', 'info');

            try {
                if (!auth) {
                    throw new Error('Firebase Auth not initialized');
                }

                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                log('Provider configured successfully', 'success');
                log(`Provider ID: ${provider.providerId}`, 'info');
                log(`Scopes: ${provider.scopes.join(', ')}`, 'info');

                log('Attempting sign-in with popup...', 'info');
                const result = await auth.signInWithPopup(provider);

                log('✅ Google sign-in successful!', 'success');
                log(`User UID: ${result.user.uid}`, 'info');
                log(`User Email: ${result.user.email}`, 'info');

                showUserInfo(result.user);

            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
                log(`Error Code: ${error.code}`, 'error');
                log(`Full Error: ${JSON.stringify(error)}`, 'error');
            }
        }

        async function testGoogleAuthRedirect() {
            log('Starting Google Auth test (Redirect method)...', 'info');

            try {
                if (!auth) {
                    throw new Error('Firebase Auth not initialized');
                }

                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                log('Provider configured successfully', 'success');
                log('Redirecting to Google...', 'info');

                await auth.signInWithRedirect(provider);

            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
                log(`Error Code: ${error.code}`, 'error');
            }
        }

        // Handle redirect result
        async function handleRedirectResult() {
            try {
                const result = await auth.getRedirectResult();
                if (result.credential) {
                    log('✅ Google sign-in successful via redirect!', 'success');
                    log(`User UID: ${result.user.uid}`, 'info');
                    log(`User Email: ${result.user.email}`, 'info');
                    showUserInfo(result.user);
                }
            } catch (error) {
                log(`❌ Redirect error: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Test page loaded', 'info');
            log('Firebase Auth available: ' + (typeof auth !== 'undefined'), 'info');
            log('Firebase App available: ' + (typeof firebase !== 'undefined'), 'info');

            // Handle redirect result
            handleRedirectResult();

            // Listen for auth state changes
            if (auth) {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        log(`Auth state changed: User logged in (${user.email})`, 'success');
                        showUserInfo(user);
                    } else {
                        log('Auth state changed: No user', 'info');
                        document.getElementById('user-info').style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>

</html>
